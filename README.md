# SqlScriptGenerator

[![Image from Gyazo](https://i.gyazo.com/0d2339ad1c7366c39b651b90cb5a7218.png)](https://gyazo.com/0d2339ad1c7366c39b651b90cb5a7218)

## What

This tool generates an script with all the selected functions/stored procedures with an drop query at first. This is being used when you want to update an existing function/sp in another environment.

## Why

Because I'm quite lazy and if something that takes me more than a minute can be automated, why not.

## Where

You can use the botons to save it to your clipboard or in a file.

## Example

```sql

-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.agent_datetime
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'agent_datetime' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP FUNCTION  [dbo].[agent_datetime] 
 GO

CREATE FUNCTION agent_datetime(@date int, @time int)
RETURNS DATETIME
AS
BEGIN
 RETURN
  (
    CONVERT(DATETIME,
          CONVERT(NVARCHAR(4),@date / 10000) + N'-' + 
          CONVERT(NVARCHAR(2),(@date % 10000)/100)  + N'-' +
          CONVERT(NVARCHAR(2),@date % 100) + N' ' +        
          CONVERT(NVARCHAR(2),@time / 10000) + N':' +        
          CONVERT(NVARCHAR(2),(@time % 10000)/100) + N':' +        
          CONVERT(NVARCHAR(2),@time % 100),
    120)
  )
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_fetch_system_flags
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_fetch_system_flags' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_fetch_system_flags] 
 GO

CREATE PROCEDURE autoadmin_fetch_system_flags
AS
BEGIN
	BEGIN TRANSACTION
		DECLARE @value NVARCHAR(MAX)

		SELECT @value = value FROM autoadmin_system_flags WHERE LOWER(name) = LOWER(N'SSMBackup2WAEverConfigured')
		
		IF (LOWER(ISNULL(@value, '')) <> N'true')
		BEGIN
			DECLARE @is_configured BIT
			SET @is_configured = 0
			
			IF EXISTS (SELECT TOP 1 container_url FROM managed_backup.fn_backup_db_config(NULL) WHERE container_url IS NOT NULL)
			BEGIN
				SET @is_configured = 1	
			END
			ELSE IF EXISTS (SELECT TOP 1 container_url FROM managed_backup.fn_backup_instance_config() WHERE container_url IS NOT NULL)
			BEGIN
				SET @is_configured = 1	
			END
			ELSE IF EXISTS (SELECT TOP 1 credential_name FROM smart_admin.fn_backup_db_config(NULL) WHERE credential_name IS NOT NULL)
			BEGIN
				SET @is_configured = 1	
			END
			ELSE IF EXISTS (SELECT TOP 1 credential_name FROM smart_admin.fn_backup_instance_config() WHERE credential_name IS NOT NULL)
			BEGIN
				SET @is_configured = 1	
			END
			
			IF (@is_configured = 1)
			BEGIN
				MERGE autoadmin_system_flags AS target
				USING (SELECT LOWER(N'SSMBackup2WAEverConfigured') as name) AS source
				ON source.name = target.name
				WHEN MATCHED THEN UPDATE SET target.value = N'true'
				WHEN NOT MATCHED THEN INSERT VALUES (N'SSMBackup2WAEverConfigured', N'true');
			END
		END
	COMMIT TRANSACTION
	
    SELECT name,
	value 
	FROM autoadmin_system_flags
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_cleanup
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_cleanup' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_cleanup] 
 GO
-- Procedure to cleanup managed backup metadata( internal only ) 
CREATE PROC autoadmin_metadata_cleanup
	@schema_version INT,
	@agent_started BIT       = 0, -- flag to specify if agent was started atleast once
	@instance_configured BIT = 0  -- flag to specify managed backup was configured at instance level
AS
BEGIN
    -- Validations

    -- If agent is running state, let us not proceed
    DECLARE @agent_service_status INT
    SELECT @agent_service_status = [status]
    FROM sys.dm_server_services
    WHERE servicename like'%SQL Server Agent%'
    
    -- Status 4 is running - http://msdn.microsoft.com/en-us/library/hh204542.aspx
    IF(@agent_service_status = 4)
    BEGIN
		RAISERROR ('Cannot perform cleanup while SQL Server Agent is currently running', -- Message text
				   17, -- Severity,
				   1); -- State
        RETURN
    END
	
	-- if schema version is 2 & @instance_configured is 1, then report back that user can configure managed backup via V2 API
	IF((@schema_version = 2) AND (@instance_configured = 1))
	BEGIN
		RAISERROR ('Managed backup V2 instance configuration as part of cleanup is not supported', -- Message text
				   17, -- Severity,
				   2); -- State
        RETURN
	END

	BEGIN TRANSACTION

	DECLARE @task_agent_data xml

	IF(@schema_version = 2)
	BEGIN
	    -- V2 default task data xml
		SET @task_agent_data = '<AutoBackupGlobalDataV2 xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schemas.datacontract.org/2004/07/Microsoft.SqlServer.SmartAdmin.SmartBackupAgent">
  <defaultAutoBackupSetting>false</defaultAutoBackupSetting>
  <defaultBackupBeginTime>0001-01-01T00:00:00</defaultBackupBeginTime>
  <defaultBackupDuration>-P10675199DT2H48M5.4775808S</defaultBackupDuration>
  <defaultContainerUrl i:nil="true" />
  <defaultDaysOfWeek>NoDay</defaultDaysOfWeek>
  <defaultEncryptionAlgorithm i:nil="true" />
  <defaultEncryptorName i:nil="true" />
  <defaultEncryptorType i:nil="true" />
  <defaultFullBackupFreqType i:nil="true" />
  <defaultLocalCachePath i:nil="true" />
  <defaultLogBackupFreq>-P10675199DT2H48M5.4775808S</defaultLogBackupFreq>
  <defaultRetentionPeriod>0</defaultRetentionPeriod>
  <defaultSchedulingOption>SYSTEM</defaultSchedulingOption>
  <firstConfiguredAt>0001-01-01T00:00:00</firstConfiguredAt>
</AutoBackupGlobalDataV2>'

		EXEC autoadmin_metadata_delete

	END
	ELSE
	BEGIN
		IF(@instance_configured = 0)
		BEGIN
			-- V1 default task data -instance not configured
			SET @task_agent_data = '<AutoBackupGlobalData xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schemas.datacontract.org/2004/07/Microsoft.SqlServer.SmartAdmin.SmartBackupAgent">
	  <defaultAutoBackupSetting>false</defaultAutoBackupSetting>
	  <defaultCredentialName i:nil="true" />
	  <defaultEncryptionAlgorithm i:nil="true" />
	  <defaultEncryptorName i:nil="true" />
	  <defaultEncryptorType i:nil="true" />
	  <defaultRetentionPeriod>0</defaultRetentionPeriod>
	  <defaultURL i:nil="true" />
	  <firstConfiguredAt>0001-01-01T00:00:00</firstConfiguredAt>
	</AutoBackupGlobalData>'
		END
		ELSE
		BEGIN
		    -- V1 default task data -instance configured
			SET @task_agent_data = '<AutoBackupGlobalData xmlns:i="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schemas.datacontract.org/2004/07/Microsoft.SqlServer.SmartAdmin.SmartBackupAgent">
  <defaultAutoBackupSetting>false</defaultAutoBackupSetting>
   <defaultCredentialName>AzureCredential</defaultCredentialName>
  <defaultEncryptionAlgorithm i:nil="true" />
  <defaultEncryptorName i:nil="true" />
  <defaultEncryptorType i:nil="true" />
  <defaultRetentionPeriod>0</defaultRetentionPeriod>
  <defaultURL i:nil="true" />
  <firstConfiguredAt>0001-01-01T00:00:00</firstConfiguredAt>
</AutoBackupGlobalData>'
		END

		IF(ISNULL(@agent_started, 0) = 0)
		BEGIN
		    -- SQL Agent was never started, Remove all entries in managed backup tables
			EXEC autoadmin_metadata_delete
		END
		ELSE
		BEGIN
			UPDATE autoadmin_task_agent_metadata
			SET schema_version = 1
			WHERE  task_agent_data IS NULL
		END
	END
		
	-- Only if SQL Agent was started atleast once, or instance was configured
	-- we could see default V1/V2 in table autoadmin_metadata_insert_task_agent_global_data
	IF(ISNULL(@agent_started, 0) = 1) OR (ISNULL(@instance_configured, 0) = 1)
	BEGIN
	   -- Insert or update global instance metadata
		EXEC autoadmin_metadata_insert_task_agent_global_data @schema_version = @schema_version, 
			@task_agent_guid = '6DF5825B-945C-4081-A4E3-292556E99B99',
			@task_agent_data = @task_agent_data

		-- Turn on Master Switch
		EXEC autoadmin_set_master_switch @state = 1
	END

	COMMIT TRANSACTION
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_delete
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_delete' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_delete] 
 GO
-- Procedure to delete entries in metadata tables
CREATE PROC autoadmin_metadata_delete
AS
BEGIN
	PRINT 'Cleaning up managed backup metadata tables...'

	PRINT 'Deleting entries from autoadmin_managed_databases...'
	DELETE FROM autoadmin_managed_databases

	PRINT 'Deleting entries from autoadmin_task_agent_metadata...'
	DELETE FROM autoadmin_task_agent_metadata

	PRINT 'Deleting entries from autoadmin_system_flags...'
	DELETE FROM autoadmin_system_flags

	PRINT 'Deleting entries from autoadmin_master_switch...'
	DELETE FROM autoadmin_master_switch

	PRINT 'Deleting entries from smart_backup_files...'
	DELETE FROM smart_backup_files

END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_delete_task_agent_data_for_database
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_delete_task_agent_data_for_database' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_delete_task_agent_data_for_database] 
 GO

CREATE PROCEDURE autoadmin_metadata_delete_task_agent_data_for_database
        @schema_version  INT,
        @task_agent_guid UNIQUEIDENTIFIER,
        @db_name         NVARCHAR(128),
        @db_id           INT,
        @db_guid         UNIQUEIDENTIFIER
AS
BEGIN
    IF (@schema_version IS NULL) OR 
		(@task_agent_guid IS NULL) OR 
		(@db_name IS NULL) OR 
		(@db_id IS NULL) OR 
		(@db_guid IS NULL)
    BEGIN
        RAISERROR ('All parameters must be specified and non-NULL. Cannot complete task agent metadata deletion for database.', -- Message text.
                   17, -- Severity,
                   1); -- State
        RETURN
    END

    SET NOCOUNT OFF

    BEGIN TRANSACTION
        -- Step 1: Delete the task agent's row in autoadmin_task_agent_metadata for the specified database
        -- Note: deletes are only executed for a database that has been dropped.
        --
        DELETE autoadmin_task_agent_metadata 
		FROM autoadmin_task_agent_metadata aatam
        WHERE aatam.task_agent_guid = @task_agent_guid
				AND aatam.schema_version = @schema_version
                AND aatam.autoadmin_id IN
        (SELECT aamd.autoadmin_id FROM autoadmin_managed_databases aamd
            WHERE aamd.db_id = @db_id 
              AND aamd.db_name = @db_name
              AND aamd.db_guid = @db_guid
              AND aamd.drop_date IS NOT NULL)

        IF (@@ROWCOUNT = 0)
        BEGIN
            DECLARE @Msg NVARCHAR(256)
            SET @Msg = N'The database %s (ID = %d) has either not been dropped, never existed, or its task agent data was deleted earlier. Cannot delete task agent data from auto-admin tables.';

            RAISERROR (@Msg, -- Message text.
                       17, -- Severity,
                       1, -- State,
                       @db_name, @db_id); -- formatting arguments
            GOTO QuitWithRollback
        END

        SET NOCOUNT ON

        -- Step 2: Garbage collection on autoadmin_managed_databases.
        -- Delete rows from autoadmin_managed_databases that do not have any corresponding rows left in autoadmin_task_agent_metadata

        DELETE autoadmin_managed_databases FROM autoadmin_managed_databases aamd
            WHERE aamd.drop_date IS NOT NULL
            AND aamd.autoadmin_id NOT IN (SELECT autoadmin_id 
                                            FROM autoadmin_task_agent_metadata
                                            WHERE schema_version = @schema_version)

	QuitWithCommit:
		COMMIT TRANSACTION
		GOTO ProcEnd

	QuitWithRollback:
		IF (@@TRANCOUNT > 0) ROLLBACK TRANSACTION

	ProcEnd:
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_delete_task_agent_global_data
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_delete_task_agent_global_data' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_delete_task_agent_global_data] 
 GO

CREATE PROCEDURE autoadmin_metadata_delete_task_agent_global_data
        @schema_version          INT,
        @task_agent_guid         UNIQUEIDENTIFIER
AS
BEGIN
    IF (@schema_version IS NULL) OR (@task_agent_guid IS NULL)
    BEGIN
        RAISERROR ('All parameters must be specified and non-NULL. Cannot complete task agent global metadata deletion', -- Message text.
                   17, -- Severity,
                   1); -- State
        RETURN
    END

    SET NOCOUNT ON

    BEGIN TRANSACTION  
	    DELETE FROM autoadmin_task_agent_metadata
            WHERE autoadmin_task_agent_metadata.task_agent_guid = @task_agent_guid 
		    AND autoadmin_task_agent_metadata.autoadmin_id = 0
		    AND autoadmin_task_agent_metadata.schema_version = @schema_version
    COMMIT TRANSACTION
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_insert_task_agent_global_data
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_insert_task_agent_global_data' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_insert_task_agent_global_data] 
 GO

CREATE PROCEDURE autoadmin_metadata_insert_task_agent_global_data
        @schema_version          INT,                
        @task_agent_guid         UNIQUEIDENTIFIER,
        @task_agent_data         XML
AS
BEGIN
    IF (@schema_version IS NULL) OR 
		(@task_agent_guid IS NULL) OR 
		(@task_agent_data IS NULL)
    BEGIN
        RAISERROR ('All parameters must be specified and non-NULL. Cannot complete task agent global metadata insertion', -- Message text.
                   17, -- Severity,
                   1); -- State
        RETURN
    END

    SET NOCOUNT ON

    BEGIN TRANSACTION
		
		DELETE FROM autoadmin_task_agent_metadata 
		WHERE autoadmin_id = 0

        INSERT INTO autoadmin_task_agent_metadata
			(task_agent_guid, 
			autoadmin_id, 
			last_modified, 
			task_agent_data, 
			schema_version)
        VALUES (@task_agent_guid, 
			0, 
			CURRENT_TIMESTAMP, 
			@task_agent_data, 
			@schema_version)

    COMMIT TRANSACTION
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_query_dbs
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_query_dbs' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_query_dbs] 
 GO

CREATE PROCEDURE autoadmin_metadata_query_dbs
        @task_agent_guid 	UNIQUEIDENTIFIER,
        @schema_version 	INT,
        @db_name 			SYSNAME = NULL
AS
BEGIN
    IF (@task_agent_guid IS NULL) OR (@schema_version IS NULL)
    BEGIN
    RAISERROR ('All parameters except @db_name must be non-NULL. Cannot complete auto-admin query for databases', -- Message text.
               17, -- Severity,
               1); -- State
    RETURN
    END

    -- The first part of this proc updates all autoadmin tables based on the current set of databases

    SET NOCOUNT ON

    -- Updates Step 1: For every existing database that does not have a row in autoadmin_managed_databases
    -- insert a new row into autoadmin_managed_databases
    --
    BEGIN TRANSACTION
        DECLARE @result INT
		DECLARE @empty_guid UNIQUEIDENTIFIER
		
		SET @empty_guid = '00000000-0000-0000-0000-000000000000'

        -- To avoid issues arising from two threads trying to refresh agent metadata at the same time we allow only one thread to 
        -- proceed at a time using the application lock below. However if a thread has to wait on the lock, it needn't do 
        -- a full refresh since the data was very recently refreshed. We just return whatever we have in our metadata tables.
        --
        EXEC @result = sp_getapplock @Resource = N'SSMBack2WAMetadataRefresh',
                                     @LockMode  = N'Exclusive',
                                     @DbPrincipal = N'dbo'

        IF @result = 1	-- Lock was granted after some wait, meaning another thread was refreshing. No need to refresh again.
        BEGIN
             GOTO release;
        END
        ELSE IF @result <> 0
        BEGIN
             RAISERROR ('Application lock couldn''t be granted for refreshing agent metadata', -- Message text.
                              17, -- Severity,
                              2); -- State
             RETURN
        END	
	
        BEGIN TRY
		INSERT INTO autoadmin_managed_databases (db_name, db_id, db_guid, group_db_guid, drop_date)
		SELECT dbs.name, dbs.database_id, dbrs.database_guid, dbs.group_database_id, NULL
		    FROM sys.databases dbs
		    INNER JOIN sys.database_recovery_status dbrs ON dbs.database_id = dbrs.database_id
		    WHERE NOT EXISTS (SELECT 1
				      FROM autoadmin_managed_databases aamd
				      WHERE aamd.db_id = dbs.database_id 
				      AND aamd.db_name = dbs.name
				      AND aamd.db_guid = dbrs.database_guid
				     )
		    AND ISNULL(dbrs.database_guid, @empty_guid) <> @empty_guid
			AND dbs.source_database_id IS NULL

		-- Updates Step 2: For every row in autoadmin_managed_databases that does not have a corresponding row in 
		-- sys.databases etc., if drop_date is not NULL then set it to the current date/time. We use db_name and
		-- db_id to locate a row in sys.databases. If a database is dropped and another database is created with
		-- the same name immediately afterwards, it might get the same db_id; in which case db_guid will be used to 
		-- distinguish the databases. However, if a database is set to OFFLINE, its db_guid becomes NULL and we might 
		-- incorrectly mark the database as dropped as the db_guids won't match. So, we specially handle NULL and empty 
		-- GUIDs. The query will also unmark a detached database as dropped if it is re-attached in the same instance.
		--
		UPDATE aamd
		SET aamd.drop_date = 
			(
				CASE 
				WHEN NOT EXISTS 
					(
						SELECT 1
						FROM sys.databases dbs
						JOIN sys.database_recovery_status dbrs
						ON dbs.database_id = dbrs.database_id
						WHERE dbs.database_id = aamd.db_id
						AND dbs.name = aamd.db_name
						AND (dbrs.database_guid = aamd.db_guid
						OR ISNULL(dbrs.database_guid, @empty_guid) = @empty_guid)
					) 
				THEN ISNULL(aamd.drop_date, SYSDATETIME())
				ELSE NULL
				END
			)
		FROM autoadmin_managed_databases aamd

		-- Updates Step 3: Update the group_database_id for databases if changed since last read. This happens when a database
		-- joins or leaves an availability group.
		--
		UPDATE aamd
		SET aamd.group_db_guid = dbs.group_database_id
		FROM sys.databases dbs
		INNER JOIN sys.database_recovery_status dbrs ON dbs.database_id = dbrs.database_id
		INNER JOIN autoadmin_managed_databases aamd
		     ON aamd.db_id = dbs.database_id 
		     AND aamd.db_name = dbs.name
		     AND aamd.db_guid = dbrs.database_guid
		WHERE ISNULL(aamd.group_db_guid, 0x0) <> ISNULL(dbs.group_database_id, 0x0)

		-- Updates Step 4: For every existing database that does not have a row in autoadmin_task_agent_metadata for the calling task agent
		-- insert a new row into autoadmin_task_agent_metadata.
		--
		INSERT INTO autoadmin_task_agent_metadata (task_agent_guid, autoadmin_id, last_modified, task_agent_data)
		SELECT @task_agent_guid, aamd.autoadmin_id, CURRENT_TIMESTAMP, NULL
		    FROM sys.databases dbs
		    INNER JOIN sys.database_recovery_status dbrs ON dbs.database_id = dbrs.database_id
		    INNER JOIN autoadmin_managed_databases aamd
			     ON aamd.db_id = dbs.database_id 
			     AND aamd.db_name = dbs.name
			     AND aamd.db_guid = dbrs.database_guid
		    LEFT OUTER JOIN autoadmin_task_agent_metadata aatam ON aatam.autoadmin_id = aamd.autoadmin_id AND aatam.task_agent_guid = @task_agent_guid
		    WHERE 
				aatam.task_agent_guid IS NULL 
				AND aamd.drop_date IS NULL
				AND dbs.source_database_id IS NULL
        END TRY
	BEGIN CATCH
		EXEC sp_releaseapplock @DbPrincipal = 'dbo', @Resource = 'SSMBack2WAMetadataRefresh';
		THROW
	END CATCH

release:
    EXEC sp_releaseapplock @DbPrincipal = 'dbo', @Resource = 'SSMBack2WAMetadataRefresh';

    COMMIT TRANSACTION

    -- Updates are now complete.
    -- The second part of this proc returns a join of database metadata and associated autoadmin metadata

    -- Do a join of sys.databases, sys.database_recovery_status, sys.database_mirroring, autoadmin_managed_databases and autoadmin_task_agent_metadata.
    -- The returned rowset will appear as follows:
    -- Existing databases will have columns for most tables (exception is sys.database_mirroring.mirroring_role which may be NULL)
    -- Dropped databases that have not be deleted by the specified task agent will have columns in autoadmin_managed_databases and autoadmin_task_agent_metadata.
    -- Dropped databases that have been deleted by the specified task agent will not have any rows
    --
	
	SET @db_name = ISNULL(@db_name, '')

	SELECT
	dbs.state db_state,
	dbs.create_date db_create_date,
	dbs.recovery_model db_recovery_model, 
	dbs.is_read_only db_read_only, 
	dbs.target_recovery_time_in_seconds db_recovery_time, 
	dbm.mirroring_role db_mirroring_role,
	aamd.db_name db_name,
	aamd.db_id db_id,
	aamd.db_guid db_guid,
	aamd.group_db_guid group_db_guid,
	(SELECT group_id FROM sys.dm_hadr_database_replica_states WHERE group_database_id = aamd.group_db_guid AND is_local = 1) group_guid,
	aamd.drop_date drop_date,
	sys.fn_hadr_backup_is_preferred_replica(db_name) as is_preferred_backup_replica,
	aatam.last_modified last_modified,
	aatam.task_agent_data task_agent_data,
	aatam.schema_version schema_version
	FROM sys.databases dbs 
	INNER JOIN sys.database_recovery_status dbrs ON dbs.database_id = dbrs.database_id
	INNER JOIN sys.database_mirroring dbm ON dbm.database_id = dbs.database_id
	RIGHT OUTER JOIN autoadmin_managed_databases aamd ON aamd.db_id = dbs.database_id and aamd.db_guid = dbrs.database_guid
	INNER JOIN autoadmin_task_agent_metadata aatam ON aatam.autoadmin_id = aamd.autoadmin_id AND aatam.task_agent_guid = @task_agent_guid
	WHERE 
	(
		QUOTENAME(@db_name) = QUOTENAME('') OR
		QUOTENAME(@db_name) = QUOTENAME(aamd.db_name)
	)
	AND @schema_version = aatam.schema_version
	AND dbs.source_database_id IS NULL
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_query_schema_version
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_query_schema_version' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_query_schema_version] 
 GO
CREATE PROCEDURE autoadmin_metadata_query_schema_version
        @current_schema_version			INT OUT,
        @min_schema_version_supported	INT OUT
AS
BEGIN
    SET NOCOUNT ON

    SET @current_schema_version = dbo.fn_autoadmin_schema_version()
    SET @min_schema_version_supported = dbo.fn_autoadmin_min_schema_version()
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_query_task_agent_global_data
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_query_task_agent_global_data' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_query_task_agent_global_data] 
 GO

CREATE PROCEDURE autoadmin_metadata_query_task_agent_global_data
        @schema_version						INT,
        @task_agent_guid					UNIQUEIDENTIFIER,
        @task_agent_data					XML OUTPUT,
		@task_agent_data_schema_version		INT OUTPUT
AS
BEGIN
    IF (@task_agent_guid IS NULL)
    BEGIN
        RAISERROR ('All parameters must be specified. Cannot complete task agent global metadata query', -- Message text.
                   17, -- Severity,
                   1); -- State
        RETURN
    END

    SET NOCOUNT ON

	-- if no records were found, null is returned in @task_agent_data.. it is upto caller's responsbility to handle this case
    SELECT @task_agent_data = aatam.task_agent_data,
			@task_agent_data_schema_version = aatam.schema_version
		FROM autoadmin_task_agent_metadata aatam
		WHERE aatam.task_agent_guid = @task_agent_guid 
		AND aatam.autoadmin_id = 0
		AND (ISNULL(@schema_version, 0 ) = 0
			OR aatam.schema_version = @schema_version)

	IF(@task_agent_data_schema_version IS NULL)
	BEGIN
	    -- If null was returned in above query, Get latest schema version & return
		SET @task_agent_data_schema_version = dbo.fn_autoadmin_schema_version()
	END
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_update_task_agent_data_for_database
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_update_task_agent_data_for_database' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_update_task_agent_data_for_database] 
 GO

CREATE PROCEDURE autoadmin_metadata_update_task_agent_data_for_database
        @schema_version  INT,
        @task_agent_guid UNIQUEIDENTIFIER,
        @db_name         NVARCHAR(128),
        @db_id           INT,
        @db_guid         UNIQUEIDENTIFIER,
        @last_modified   DATETIME,
        @task_agent_data XML
AS
BEGIN
    IF (@schema_version IS NULL) OR 
		(@task_agent_guid IS NULL) OR 
		(@db_name IS NULL) OR 
		(@db_id IS NULL) OR 
		(@db_guid IS NULL) OR 
		(@task_agent_data IS NULL)
    BEGIN
        RAISERROR ('All parameters must be specified and non-NULL. Cannot complete task agent metadata update for database.', -- Message text.
                   17, -- Severity,
                   1); -- State
        RETURN
    END

    DECLARE @last_modified_time DATETIME
    SET NOCOUNT OFF

    BEGIN TRANSACTION

		-- Get last modifed time for database record,  it could be v1 or v2; that is why we dont filter based on schema version
        SELECT @last_modified_time = last_modified 
        FROM autoadmin_task_agent_metadata aatam, autoadmin_managed_databases aamd
            WHERE aamd.db_id = @db_id 
                AND aamd.db_name = @db_name
                AND aamd.db_guid = @db_guid
                AND aamd.autoadmin_id = aatam.autoadmin_id
                AND aatam.task_agent_guid = @task_agent_guid

        IF (@last_modified > @last_modified_time) 
        BEGIN
            UPDATE autoadmin_task_agent_metadata 
	        SET task_agent_data = @task_agent_data, 
	            last_modified = @last_modified,
		        schema_version = @schema_version
                FROM autoadmin_task_agent_metadata aatam, autoadmin_managed_databases aamd
                WHERE aamd.db_id = @db_id 
                    AND aamd.db_name = @db_name
                    AND aamd.db_guid = @db_guid
                    AND aamd.autoadmin_id = aatam.autoadmin_id
                    AND aatam.task_agent_guid = @task_agent_guid 
        END
    COMMIT TRANSACTION
END

GO
-- ========================================================================================== 
-- This routine has been autogenerated 
-- Source code for this tool is at https://github.com/emimontesdeoca/sql-script-generator-gui 
-- Source query: dbo.autoadmin_metadata_update_task_agent_global_data
-- Create date: 30/08/2019 12:46:18
-- Database: msdb
-- User: sa
-- ========================================================================================== 
 IF EXISTS 
 (SELECT * FROM Information_schema.Routines R WHERE R.ROUTINE_NAME = 'autoadmin_metadata_update_task_agent_global_data' AND R.ROUTINE_SCHEMA = 'dbo') 
 DROP PROCEDURE [dbo].[autoadmin_metadata_update_task_agent_global_data] 
 GO

CREATE PROCEDURE autoadmin_metadata_update_task_agent_global_data
        @schema_version          INT,
        @task_agent_guid         UNIQUEIDENTIFIER,
        @task_agent_data         XML
AS
BEGIN
    IF (@schema_version IS NULL) OR 
		(@task_agent_guid IS NULL) OR 
		(@task_agent_data IS NULL)
    BEGIN
        RAISERROR ('All parameters must be specified and non-NULL. Cannot complete task agent global metadata update', -- Message text.
                   17, -- Severity,
                   1); -- State
        RETURN
    END

    SET NOCOUNT OFF

    BEGIN TRANSACTION

        UPDATE autoadmin_task_agent_metadata 
		SET task_agent_data = @task_agent_data,
		schema_version = @schema_version
        WHERE autoadmin_task_agent_metadata.task_agent_guid = @task_agent_guid 
		AND autoadmin_task_agent_metadata.autoadmin_id = 0
    
	COMMIT TRANSACTION

END

GO


```